# 网络层概述
1. 网络层的分解
      - 数据平面
      - 控制平面
2. 数据平面功能:网络中每台路由器的功能，决定到达路由器输入链路之一的数据报如何转发到该路由器的输出链路之一
	1. 传统 IP 转发 (转发基于数据报的目的地址)
	2. 通用转发 (使用数据报首部中几个不同域执行转发和其他功能)
3. 控制平面功能:网络范围的逻辑，控制数据报沿着从源主机沿着到目的主机的端到端路径中路由器的路由方式
	1. 路由选择算法
4. 软件定义网络(Software-Defined Networking, SDN):将控制平面功能作为一种单独服务，明确地分离数据平面和控制平面
## 转发和路由选择:数据平面和控制平面
1. 转发(forwarding):将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作
      - 数据平面中实现的唯一功能
      - 分组有可能被现有的路由器阻挡也有可能冗余的经过多条链路发送
2. 路由选择(routing):确定分组从源到目的地所采取的端到端路径的网络范围处理过程，通常用软件来实现
      - 路由选择算法(routing algorithm):计算分组从发送方流向接收方时采用的路由或路径
      - 在控制平面中实现
3. 转发表(forwarding table):路由器检查到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引
4. 转发表的配置
      - 控制平面:传统方法
        - 路由选择算法决定了插入路由器转发表的内容，在一台路由器中的路由选择算法与其他路由器重的算法通信，计算出转发表的值
      - 控制平面:SDN方法![[Pasted image 20231116172535.png]]
        - 路由选择设备仅执行转发，而远程控制器计算并分发转发表
5. 软件定义网络 (Software-Defined Networking, SDN) 的本质：计算转发表并与路由器交互的控制器是用软件实现的 (控制器可能实现在具有高可靠性和冗余的远程数据中心中)
## 网络服务模型
1. 网络服务模型(network service model)定义了分组在发送和接收端系统之间的端到端运输特性
2. 考虑几种网络层能提供的可能的服务：参考[[应用层#可供应用程序使用的运输服务]]
	1. 确保交付
	2. 具有时延上界的确保交付
	3. 有序分组交付
	4. 确保最小带宽
	5. 安全性
	6. 很遗憾的是，以上提到的服务，因特网的网络层一个也不提供，因特网的网络层提供了单一的服务，称为**尽力而为服务 (best-effort service)** ~~没有服务就是最好的服务~~
3. 尽力而为服务(best-effort service):因特网网络层提供的单一服务，传送的分组既不能保证以发送的顺序被接收，也不能保证最终交付，既不能保证端到端时延，也不能保证有最小的带宽
4. ⚠️转发和交换这两个术语经常被互换使用
5. 分组交换机:通用分组交换设备，根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组
      - 链路层交换机(link-layer switch):基于链路层帧中的字段值做出转发决定
      - 路由器(router):基于网络数据报中的首部字段值做出转发决定
# 路由器工作原理
1. 路由器组件![[Pasted image 20231117111524.png]]
      - 输入端口(input port)
        - 终结入物理链路的物理层功能
        - 与位于远端的数据链路层交互来执行数据链路层功能
        - 查询转发表决定路由器的输出端口
        - 控制分组从输入端口(指物理IO接口，与软件端口不同)转发到路由选择处理器
      - 交换结构:将路由器的输入端口连接到输出端口，这种交换结构时网络路由器中的网络
      - 输出端口:存储从交换结构接收的分组，通过执行必要的链路层和物理层功能在输出链路上传输这些分组(双向链路输出端口总是和输入端口**成对**出现在同一线路卡上)
      - 路由选择处理器:执行控制平面功能，
        - 传统路由器:执行路由选择协议，维护路由选择表与关联链路状态信息
        - SDN 路由器:负责与远端控制器通信，接收由远程控制器计算的转发表项
2. 路由器的输入端口、输出端口和交换结构几乎总是用硬件实现

### 输入端口处理和基于目的地转发
![[Pasted image 20231117152150.png|500]]
1. 输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层
2. 转发表从路由选择处理器经过独立总线 (eg. PCI) 复制到线路卡
3. 使用每个输入端口的影子副本，转发决策可在每个输入端口本地做出，避免了集中式处理瓶颈
4. 路由器通过前缀(prefix)匹配来转发分组，当有多个匹配时使用最长前缀匹配规则(longest prefix matching rule)
5. 在吉比特速率下，查找转发表必须在纳秒级执行，需要对大型转发表使用超出简单线性搜索的技术，实践中常用三态内容可寻址存储器(Tenary Content Address Memory, TCAM) 来查找，使用 TCAM 一个 32 位 IP 地址可在常数时间内返回对应的转发表项
6. 在某些设计中，如果来自其他输入输出端口的分组当前正在使用该交换结构，一个分组可能在进入交换结构时被阻塞，这个被阻塞的分组需要在输入端口处排队
7. 输入端口除了查找仍需要处理的事情
      - 物理层和链路层处理
      - 检查分组的版本号、检验和以及寿命字段，并重写最后两个字段
      - 更新用于网络管理的计数器
### 交换
1. 路由器通过交换结构使分组实际地从一个输入端口交换到另一个输出端口中
2. 交换可以用许多方式完成：
	1. 经内存交换 ![[Pasted image 20231117163834.png|400]]
		1. 最简单、最早的路由器使传统的计算机，输入端口和输出段口之间的交换是在 CPU (路由选择处理器) 的控制下完成的
		2. 处理首部时分组需要被复制到内存中，所以转发吞吐量受到内存带宽限制
		3. 共享系统总线一次只能执行一个内存读 / 写，所以不能同时转发两个分组
		4. 现代路由器由输入线路卡查找目的地址和将分组存储进适当的内存存储位置
	2. 经总线交换 ![[Pasted image 20231117163932.png|400]]
		1. 输入端口经一根共享总线将分组直接传送到输出端口
		2. 输入端口为分组预先计划一个交换机内部标签，指示本地输出端口，分组被所有输出端口收到，但只有与该标签匹配的端口才能保存该分组
		3. 一次只有一个分组能跨越总线，交换带宽受总线速率的限制
	3. 经互联网络交换 ![[Pasted image 20231117163957.png|400]]
		1. 使用更复杂的互联网络能克服单一、共享式总线的带宽限制
		2. 图中的纵横式交换机是由 2N 条总线组成的互联网络，交叉点通过交换结构控制器在任何时候能够开启和闭合
		3. 纵横式交换机是非阻塞的 (non-blocking)，只要没有其他分组当前被转发到该输出端口，转发到输出端口的分组将不会被到达输出端口的分组阻塞，如果来自两个不同输入端口的两个分组其目的地为相同的输出端口，则一个分组必须在输入端等待
## 输出端口处理
![[Pasted image 20231117171654.png|500]]
1. 输出端口取出已经存放在输出端口内存中的分组并将其发送到输出链路上
## 排队
1. 路由器在输入端口和输出端口处都能形成排队
2. 排队的位置和程度取决于流量负载、交换结构的相对速率和线路速率
3. 当无内存可用于存储到达的分组时会出现丢包 (packet loss)
### 输入排队
1. 如果瓶颈在交换结构的吞吐量，那么在输入端口将出现分组排队
2. 考虑纵横式结构，假定：
	1. 所有链路速度相同
	2. 一个分组能以一条输入链路接收一个分组所用的时间量，从任意一个输入端口传送到给定的输出端口
	3. 分组按 FCFS (First Come, First Served) 方式，若有两个分组被发往同一输出队列，其中的一个分组被阻塞
3. 线路前部阻塞 (Head-Of-the-Line, HOL) 阻塞：线路前部的另一个分组阻塞，则同一输出队列中排队的分组必须等待前部分组发送后才能发送 ![[Pasted image 20231117174816.png|500]]
### 输出排队
1. 在缓存已满时，需要做出决定
	1. 丢弃到达的分组，采用弃尾 (drop-tail) 的策略
	2. 删除一个或者多个已排队的分组
2. 主动队列管理 (Active Queue Management, AQM) 算法
	1. 在缓存填满前丢弃一个分组，可以向发送方提供一个拥塞信号
	2. 随机早期检测 (Random Early Detection, RED) 是得到最广泛研究和实现的 AQM 算法之一 ![[Pasted image 20231117191339.png|300]]
3. 当分组到达输出端口并排队时，输出端口的分组调度 (packet scheduler) 在排队分组中选择一个分组来传输
4. 路由器缓存长度的经验方法：缓存数量 (B) 应当等于平均往返时延 (RTT) 乘以链路的容量 (C)，最近的理论和试验表明，当有大量的 TCP 流 (N 条) 流过一条链路时，缓存所需要的量 $B = RTT\cdot / \sqrt N$ 
## 分组调度
1. 先进先出 (First-In-First-Out, FIFO) ![[Pasted image 20231120094352.png|500]]
	1. 如果链路正忙于传输另一个分组，则
2. ![[Pasted image 20231120095614.png]]