# 存储介质底层分析
## 光盘
1. 表面印刷层
2. 保护层
3. 反射层：喷镀的金属膜，读取数据时用来反射激光
4. 有机染料层：由不同的有机染料构成数据记录层，刻录时激光在该层进行烧蚀
5. 盘基：透明的聚碳酸脂材料
## 机械硬盘
1. 定义：机械硬盘(硬盘驱动器, HDD) 是一种机电存储设备，使用磁性存储和检索数据，其中包含一个或多个涂有磁性材料的快速旋转的刚性，盘片与磁头配对，磁头通常设置在移动的制动臂上，用于读取和写入盘片表面的数据，数据以随机访问的方式访问。
## 硬盘的外壳及盘标
一块希捷 3.5 英寸硬盘的外壳如图 2-1 所示。该硬盘的盘标信息如图 2-2 所示。盘标信息的含义如下
![[Pasted image 20240620065107.png]]
1. Seagate：硬盘的品牌，即“希捷” 
2. S/N: 9 QM 3 SMCW：硬盘的序列号。
3. ST 3500320 AS：硬盘的型号。 
4. P/N: 9 BX 154-303：硬盘的部件号。
5. Firmware: 8 D 15：硬盘的固件版本号。
6. Barracuda 7200.11：硬盘的属系，即“酷鱼 11 代”。
7. 500 Gbytes：硬盘的容量。
8. Products of Thailand：硬盘的产地。
## 硬盘的区段
1. 硬盘厂家会在每张盘片的每个面上都划分出一个一个的磁道（Track，简写为 T），每个磁道还要划分为若干个扇区（Sector，简写为 S），硬盘就是以扇区为单位来存放数据的
2. 硬盘中一般会有多个盘片，每个盘片包含两个面，每个盘面都对应地有一个读/写磁头（Head，简写为 H），每个盘面上都同样被划分成相同的磁道和扇区结构并且进行编号。所有盘面上的同一编号的磁道构成一个圆柱形结构，称为柱面（Cylinder，简称为 C），所以硬盘中某一个具体扇区的地址就由该扇区所在的盘面号（由磁头号 H 替代）、柱面号 C 及扇区号 S 三个参数组成
3. 选取磁头只需通过电子切换即可，而选取柱面则必须通过机械切换
### 逻辑 C/H/S
1. 在计算机系统 BIOS 中断 13 H 的入口参数中，磁头寄存器占 8 位，其值为 0 H～FEH，所以磁头号为 0～254。柱面地址是 10 位，所以柱面号为 0～1023，其低 8 位单独占用一个寄存器，高两位与扇区地址共用一个寄存器，占用共用寄存器中的高两位。扇区地址占用共用寄存器中的低 6 位，其值为 1 H～3 FH，所以扇区编号为 1～63
2. 按照这种地址管理模式，逻辑 C/H/S 的最大取值为 1023/254/63，因为逻辑 C/H/S 的初始值分别为 0/0/1，所以逻辑 C/H/S 能够管理的逻辑柱面、磁头、扇区的个数分别为 1024、255、63，这样就可以算出逻辑 C/H/S 能够管理的扇区总数：1024×255×63=16 450 560，把这个数值换算为 GB 的结果约等于 8 GB，这也是逻辑 C/H/S 能够管理的最大空间
### LBA (Logic Block Address)
1. 在 LBA 方式下，系统把所有的物理扇区都按照某种规则看作一线性编号的扇区，即从 0 到某个最大值方式排列，并连成一条线，把 LBA 作为一个整体来对待，而不再是具体的实际的 C/H/S 值，这样只用一个序数就确定了一个唯一的物理扇区
## 固态硬盘
1. 固态硬盘由控制单元和存储单元组成，一般使用 Flash 闪存芯片作为存储单元，不再使用传统的机械存储方法，使用模拟的方式虚拟出传统硬盘的扇区
2. 固态硬盘盘体内的主体就是一块 PCB，而这块 PCB 上最基本的配件主要有控制芯片、缓存芯片（部分低端固态硬盘无缓存芯片）和用于存储数据的闪存芯片三部分
3. SSD 中的主要内存部件传统上是 DRAM 易失性闪存，但自 2009 年来以 NAND 非易失性闪存更为常见
4. 在闪存的种类中单层单元(single-level cell, SLC) 每个存储单元只能存储一位信息，多层单元 (MLC) 每个存储单元能够存储多个位信息
![[Pasted image 20240620093504.png]]
# RAID
1. RAID（Redundant Array of Inexpensive Disks）直译为“廉价冗余磁盘阵列”，最初是为了组合多块小容量的廉价磁盘来代替大容量的昂贵磁盘，同时希望在磁盘失效时不会对数据造成影响而开发出的一种磁盘存储技术”
2. 后来随着硬盘研发技术的不断提升，硬盘的容量越来越大，成本却在不断下降，所以 RAID 中 Inexpensive（廉价）一词已经失去意义，于是将这个词用 Independent（独立）来替代，RAID 就成了“独立冗余磁盘阵列
3. RAID 通过将多个磁盘按照一定的形式和方案组织起来，以这样的形式能够获取比单个硬盘更高的速度、更好的稳定性、更大的存储能力的存储解决方案
4. RAID 技术能够提供更大的存储空间、提供更快的传输速度并且提供更高的安全性
## RAID-0
1. RAID-0 是无冗余、无校验的磁盘阵列，实现 RAID-0 至少需要两块以上硬盘。它将两块以上的硬盘合并成一块，数据同时分散在每块硬盘中，因为带宽加倍，所以读/写速度加倍。RAID-0 的理论速度是单块硬盘的 N 倍
2. RAID-0 只是单纯地提高读/写性能，并没有为数据的可靠性提供保证，而且其中的任何一个物理盘失效都将影响到所有数据，因此，RAID-0 不能应用于数据安全性要求高的场合
![[Pasted image 20240620101600.png]]
## RAID-1
1. RAID-1 通过磁盘数据镜像实现数据的冗余，在两块磁盘上产生互为备份的数据，当其中一块成员盘出现故障时，系统还可以从另外一块成员盘中读取数据，因此 RAID-1 可以提供更好的冗余性
![[Pasted image 20240620101805.png]]
## RAID-3
RAID-3 的数据存取方式和 RAID-2 一样，把数据以位或字节为单位来分割并且存储到各个硬盘上，在安全方面以奇偶校验取代海明码做错误校正及检测，所以只需要一个额外的校检磁盘。奇偶校验值的计算是以各个硬盘的相对应位作异或的逻辑运算，然后将结果写入奇偶校验硬盘
![[Pasted image 20240620102200.png]]
## RAID-5
RAID-5 跟 RAID-4 一样，数据以条带为单位分布到各个硬盘上，RAID-5 和 RAID-4 的最大区别在于 RAID-5 不是把所有的校验块集中保存在一个专门的校验盘中，而是分散到所有的数据盘中
![[Pasted image 20240620102402.png]]
# 引导记录底层分析
## MBR
### 引导过程
1. BIOS 自检通过后将 MBR 扇区读入内存，将执行权交给内存中 MBR 扇区的引导程序，引导程序将自己拷贝到相对安全的地址
2. 系统判断 MBR 扇区的最后两个字节是否为"55 AA"，若是引导程序到分区表中查找是否有活动分区，若有责将引导扇区读入内存，若该引导扇区合法，则将程序执行流跳转到引导扇区从而引导操作系统启动
### 结构
1. 引导程序 (0-1B7H)：占用其中前 440 个字节
2. Windows 磁盘签名(1B8H-1BBH)：Windows 系统对硬盘初始化时写入的一个磁盘标签，如果硬盘的签名丢失，系统会认为该硬盘没有初始化
3. 分区表(Disk Partition Table)(1BEH-1FDH)：用于管理硬盘分区
4. 结束标志(1FEH-1FFH)："55 AA"，如果破坏标志，硬盘会变成未初始化状态
### 分区表
# 文件系统底层分析
## FAT32
1. FAT 32 文件系统是从微软 Windows 95 系统的 OSR 2 版本开始使用的，它能够支持大于 32 MB 小于 32 GB 的分区。虽然第三方的格式化程序可以把超过 32 GB 的分区格式化为 FAT 32，但微软自身的系统不允许将大于 32 GB 的分区格式化为 FAT 32 文件系统
2. FAT 32 文件系统由 DBR 及其保留扇区、FAT 1、FAT 2、DATA 区四个部分组成
![[Pasted image 20240620103156.png]]
1. DBR 及其保留扇区：DBR 的全称为 DOSBoot Record，含义是 DOS 引导记录，也称为操作系统引导记录，在 DBR 之后往往有一些保留扇区
2. FAT1：FAT 的全称是 File Allocation Table，含义是文件分配表，FAT32 一般有两份 FAT，FAT1 是第一份，也是主 FAT。
3. FAT2：FAT2 是 FAT32 的第二份文件分配表，也是 FAT1 的备份。
4. DATA：数据区，是 FAT32 文件系统的主要区域，其中包含目录区域。

### DBR
1. 跳转指令：本身占 2 字节，它将程序执行流程跳转到引导程序处
2. OEM 代号：这部分占 8 字节，其内容由创建该文件系统的 OEM 产商提供
3. BPB：从第 12 个字节开始，占用 79 字节，记录了有关该文件系统的重要信息，前 53 个字节是 BPB，后面 26 个字节是扩展 BPB。各参数解释如下表：

| 字节偏移 | 字段长度 | 名称        | 定义                                                                   |
| ---- | ---- | --------- | -------------------------------------------------------------------- |
| 0x0B | 2    | 扇区字节数     | 硬件扇区的大小，合法的十进制值有 512，1024，2048，4096                                  |
| 0x0D | 1    | 每簇扇区数     | 一簇中的扇区数                                                              |
| 0x0e | 2    | 保留扇区数     | 第一个 FAT 开始之前的扇区数                                                     |
| 0x10 | 1    | FAT 数     | 该分区上 FAT 的副本数，本字段一般为 2                                               |
| 0x11 | 2    | 根目录项数     | FAT32 本字段必须设置为 0                                                     |
| 0x13 | 2    | 小扇区数      | FAT32 本字段必须设置为 0                                                     |
| 0x15 | 1    | 媒体描述符     | 提供有关媒体被使用的信息                                                         |
| 0x16 | 2    | 每 FAT 扇区数 | FAT32 本字段必须设置为 0                                                     |
| 0x18 | 2    | 每道扇区数     | -                                                                    |
| 0x1A | 2    | 磁头数       | -                                                                    |
| 0x1C | 4    | 隐藏扇区数     | 该分区上引导扇区之前的扇区数，在没有分区的媒体上它必须总是 0                                      |
| 0x20 | 4    | 总扇区数      | 本字段包含 FAT32 分区中总的扇区数                                                 |
| 0x24 | 4    | 每 FAT 扇区数 | 该分区每个 FAT 所占的扇区数，利用这个数和 FAT 数以及隐藏扇区数来决定根目录从哪开始。从目录的项数决定该分区的用户数据区从哪开始 |
| 0x28 | 2    | 扩展标志      | -                                                                    |
| 0x2A | 2    | 文件系统版本    | -                                                                    |
| 0x2C | 4    | 根目录簇号     | 根目录第一簇的簇号，一般为 2                                                      |
| 0x30 | 2    | 文件系统信息扇区号 | FAT32 分区的保留区中文件系统信息结构的扇区号                                            |
| 0x34 | 2    | 备份引导扇区    | 表示该分区保存引导扇区的副本的保留区中的扇区号，一般为 6，建议不使用其他值                               |
| 0x36 | 12   | 保留字段      | -                                                                    |
| 0x40 | 1    | 物理驱动器号    | -                                                                    |
| 0x41 | 1    | 保留        | FAT32 该字段总是 0                                                        |
| 0x42 | 1    | 扩展引导标签    | -                                                                    |
| 0x43 | 4    | 分区序号      | -                                                                    |
| 0x47 | 11   | 卷标        | -                                                                    |
| 0x52 | 8    | 系统 ID     | FAT32 中一般为"FAT32"                                                    |

### FAT 表

1. FAT32 文件一般有两份 FAT，它们由格式化程序在对分区进行格式化时创建，FAT1 是主，FAT2 是备份
2. FAT1 跟在 DBR 之后，其具体地址由 DBR 的 BPB 参数中指定，FAT2 跟在 FAT1 后面
3. FAT 表由 FAT 表项组成，每个 FAT 项占用 4 字节
4. 每个 FAT 项有个固定的编号，从 0 开始
5. FAT 表的前两个项为文件系统保留使用，0 号为介质类型，1 号为文件系统错误标志
6. 分区的数据区中每个簇都会映射到 FAT 表中的唯一一个 FAT 项，用户的数据从 2 号 FAT 开始记录
7. 如果某个文件占用很多个簇，则第一个 FAT 项记录下一个 FAT 项的编号，如果这个文件结束了，则用 `0F FF FF FF` 表示
8. 分区格式化后，用户文件以簇为单位存放在数据区中，一个文件至少占用一个簇
9. FAT 的主要作用是标明分区存储的介质以及簇的使用情况

定位 FAT 绝对位置的方法如下：
+ 首先从 MBR 的分区表中得知分区的起始扇区，偏移到此扇区
+ 从 DBR 的 BPB 中得知 DBR 的保留扇区数，FAT 表的个数，FAT 表的大小
+ 因此 FAT1 扇区号 = 分区起始扇区 + DBR 保留扇区，FAT2 扇区号 = 分区起始扇区 + DBR 保留扇区 + 每 FAT 扇区数

除了 0 号 FAT 项和 1 号 FAT 项以外，如果一个 FAT 项为非零值，那么可能有三种情况： 
 1. 该 FAT 项映射的簇是一个不可用的坏簇，那么该 FAT 项中的值为坏簇标志（对于 FAT 32 来说为“0F FF FF F7”）
 2. 该 FAT 项映射的簇是某个文件的最后一个簇，那么该 FAT 项中的值为结束标志（对于 FAT 32 来说为“0F FF FF FF”）
 3. 该 FAT 项映射的簇被某个文件占用，但并不是文件的最后一个簇，那么该 FAT 项中的值是文件下一个簇的簇号。 

分析 FAT32 文件系统的数据区
+ 定位方法：
	- 通过 MBR 中分区表信息得知分区的起始位置
	- 通过分区中 DBR 得知 DBR 的保留扇区数以及 FAT 表的大小，FAT 表的个数
	- 数据区 = 分区起始扇区 + DBR 保留扇区 + FAT 表数量 * 每 FAT 扇区数
+ 数据区的内容主要由三部分组成：根目录，子目录和文件内容
+ 数据区中以“簇”为单位进行存储，2 号簇被分配给根目录使用
+ FAT32 文件系统中，分区根目录下的文件和目录都放在根目录区中，子目录中的文件和目录都放在子目录区中，并且每 32 个字节为一个目录项（FDT），每个目录项记录着一个目录和文件或多个目录项记录一个文件和目录
+ FAT32 文件系统中，目录项可以分为四类：
	- 卷标目录项
	- ./..
	- 短文件名目录项
	- 长文件名目录项
+ FDT 第一个字节表明了该文件的状态，有下面四种取值方式：
	- 00h 目录项的空目录
	- E5H 表示该目录项曾经使用过，但文件已经被删除
	- 2EH 表示子目录下的两个特殊文件 . 或 ..
	- 其他任何字符 表示一个文件名或目录名的第一个字符的ASCII码值
+ FDT 第 0xB 个字节可以判别式长文件目录项还是短文件目录项
+ FAT32 文件目录项第 32 个字节表示一些文件的属性信息，包括文件名，扩展名，权限等

### 短文件名目录项
| 字节偏移 | 字段长度 | 字段内容及含义                                                                                              |
| ---- | ---- | ---------------------------------------------------------------------------------------------------- |
| 0x00 | 8    | 主文件名                                                                                                 |
| 0x08 | 3    | 文件扩展名                                                                                                |
| 0x0B | 1    | 文件属性：00000000(读写) 00000001(只读) 00000010(隐藏) <br>00000100(系统) 00001000(卷标) 00010000(子目录) 00100000(存档) |
| 0x0C | 1    | 未用                                                                                                   |
| 0x0D | 1    | 文件创建时间，精确到 10 ms 的值                                                                                  |
| 0x0E | 2    | 文件创建时间，包括时、分、秒                                                                                       |
| 0x10 | 2    | 文件创建日期，包括年、月、日                                                                                       |
| 0x12 | 2    | 文件最近访问日期，包括年、月、日                                                                                     |
| 0x14 | 2    | **文件起始簇号的高位**                                                                                        |
| 0x16 | 2    | 文件修改时间，包括时、分、秒                                                                                       |
| 0x18 | 2    | 文件修改日期，包括年、月、日                                                                                       |
| 0x1A | 2    | **文件起始簇号的低位**                                                                                        |
| 0x1C | 2    | 文件大小                                                                                                 |
### 长文件名目录项
| 字节偏移 | 字段长度 | 字段内容及含义                                                 |
| ---- | ---- | ------------------------------------------------------- |
| 0x00 | 1    | 序列号，从 1 开始                                              |
| 0x01 | 10   | 文件名的第 1 - 5 个 Unicode 码字符，若文件已经记录完填充“00”，随后未用的字节用“FF”填充 |
| 0x0B | 1    | 长文件名目录项的属性标志，固定为”0F“                                    |
| 0x0C | 1    | 保留未用                                                    |
| 0x0D | 1    | 短文件名校验和                                                 |
| 0x0E | 12   | 文件名的第 6 - 11 个 Unicode 码字符                              |
| 0x1A | 2    | 始终为 0                                                   |
| 0x1C | 2    | 文件名的第 12 - 13 个 Unicode 码字符                             |
### "."目录项和".."目录项
1. 两者的文件属性为子目录"00010000"
2. "."目录项所描述的"起始簇号"是子目录本身所在的簇号
3. ".."目录项所描述的"起始簇号"是上一级目录的起始簇号，如果上一级目录是根目录，则该值被置为"0"
4. 两者文件大小都为"0"
### 卷标目录项
1. 在根目录区表示分区的名字
2. ![[Pasted image 20240620145732.png]]
3. FAT 格式的分区，卷标长度最多允许达到 11 字节，支持最多 5 个中文字符
4. 不记录起始簇号和大小
5. 不记录创建时间和最后访问时间，只记录修改时间
### 删除文件
1. 文件目录项的第一个字节被改成"E5"
2. 目录项中文件起始簇号的高位 2 个字节清零，若文件在数据区存放的位置比较靠后，文件起始簇号会很大，文件记录项中高位 2 个字节会有值，会造成文件起始簇号丢失
	1. 若将文件先放入回收站，再清空回收站，不会清除起始簇号高位的两个字节
	2. 彻底删除时会
3. 文件 FAT 表的相应簇链全部清零
4. 文件的内容不会被清零，但占用的簇号会被释放，容易被其他文件进一步占用，若数据被覆盖了则文件无法恢复
5. 彻底删除文件夹时，被删除文件夹目录项中起始簇号的高位两字节会被清空，文件夹中文件的目录项不会发生变化
### 格式化
1. FAT 表中除了 0 号 FAT 项、1 号 FAT 项和 2 号 FAT 项以外会被清空
2. 根目录区会被完全清零
3. 子目录中的目录项仍然存在

## NTFS
