> 内容摘自《数据恢复技术深度解密》与各种网络资料
# 存储介质底层分析
## 光盘
1. 表面印刷层
2. 保护层
3. 反射层：喷镀的金属膜，读取数据时用来反射激光
4. 有机染料层：由不同的有机染料构成数据记录层，刻录时激光在该层进行烧蚀
5. 盘基：透明的聚碳酸脂材料
## 机械硬盘
1. 定义：机械硬盘(硬盘驱动器, HDD) 是一种机电存储设备，使用磁性存储和检索数据，其中包含一个或多个涂有磁性材料的快速旋转的刚性，盘片与磁头配对，磁头通常设置在移动的制动臂上，用于读取和写入盘片表面的数据，数据以随机访问的方式访问。
## 硬盘的外壳及盘标
一块希捷 3.5 英寸硬盘的外壳如图 2-1 所示。该硬盘的盘标信息如图 2-2 所示。盘标信息的含义如下
![[Pasted image 20240620065107.png]]
1. Seagate：硬盘的品牌，即“希捷” 
2. S/N: 9 QM 3 SMCW：硬盘的序列号。
3. ST 3500320 AS：硬盘的型号。 
4. P/N: 9 BX 154-303：硬盘的部件号。
5. Firmware: 8 D 15：硬盘的固件版本号。
6. Barracuda 7200.11：硬盘的属系，即“酷鱼 11 代”。
7. 500 Gbytes：硬盘的容量。
8. Products of Thailand：硬盘的产地。
## 硬盘的区段
1. 硬盘厂家会在每张盘片的每个面上都划分出一个一个的磁道（Track，简写为 T），每个磁道还要划分为若干个扇区（Sector，简写为 S），硬盘就是以扇区为单位来存放数据的
2. 硬盘中一般会有多个盘片，每个盘片包含两个面，每个盘面都对应地有一个读/写磁头（Head，简写为 H），每个盘面上都同样被划分成相同的磁道和扇区结构并且进行编号。所有盘面上的同一编号的磁道构成一个圆柱形结构，称为柱面（Cylinder，简称为 C），所以硬盘中某一个具体扇区的地址就由该扇区所在的盘面号（由磁头号 H 替代）、柱面号 C 及扇区号 S 三个参数组成
3. 选取磁头只需通过电子切换即可，而选取柱面则必须通过机械切换
### 逻辑 C/H/S
1. 在计算机系统 BIOS 中断 13 H 的入口参数中，磁头寄存器占 8 位，其值为 0 H～FEH，所以磁头号为 0～254。柱面地址是 10 位，所以柱面号为 0～1023，其低 8 位单独占用一个寄存器，高两位与扇区地址共用一个寄存器，占用共用寄存器中的高两位。扇区地址占用共用寄存器中的低 6 位，其值为 1 H～3 FH，所以扇区编号为 1～63
2. 按照这种地址管理模式，逻辑 C/H/S 的最大取值为 1023/254/63，因为逻辑 C/H/S 的初始值分别为 0/0/1，所以逻辑 C/H/S 能够管理的逻辑柱面、磁头、扇区的个数分别为 1024、255、63，这样就可以算出逻辑 C/H/S 能够管理的扇区总数：1024×255×63=16 450 560，把这个数值换算为 GB 的结果约等于 8 GB，这也是逻辑 C/H/S 能够管理的最大空间
### LBA (Logic Block Address)
1. 在 LBA 方式下，系统把所有的物理扇区都按照某种规则看作一线性编号的扇区，即从 0 到某个最大值方式排列，并连成一条线，把 LBA 作为一个整体来对待，而不再是具体的实际的 C/H/S 值，这样只用一个序数就确定了一个唯一的物理扇区
## 固态硬盘
1. 固态硬盘由控制单元和存储单元组成，一般使用 Flash 闪存芯片作为存储单元，不再使用传统的机械存储方法，使用模拟的方式虚拟出传统硬盘的扇区
2. 固态硬盘盘体内的主体就是一块 PCB，而这块 PCB 上最基本的配件主要有控制芯片、缓存芯片（部分低端固态硬盘无缓存芯片）和用于存储数据的闪存芯片三部分
3. SSD 中的主要内存部件传统上是 DRAM 易失性闪存，但自 2009 年来以 NAND 非易失性闪存更为常见
4. 在闪存的种类中单层单元(single-level cell, SLC) 每个存储单元只能存储一位信息，多层单元 (MLC) 每个存储单元能够存储多个位信息
![[Pasted image 20240620093504.png]]
# RAID
1. RAID（Redundant Array of Inexpensive Disks）直译为“廉价冗余磁盘阵列”，最初是为了组合多块小容量的廉价磁盘来代替大容量的昂贵磁盘，同时希望在磁盘失效时不会对数据造成影响而开发出的一种磁盘存储技术”
2. 后来随着硬盘研发技术的不断提升，硬盘的容量越来越大，成本却在不断下降，所以 RAID 中 Inexpensive（廉价）一词已经失去意义，于是将这个词用 Independent（独立）来替代，RAID 就成了“独立冗余磁盘阵列
3. RAID 通过将多个磁盘按照一定的形式和方案组织起来，以这样的形式能够获取比单个硬盘更高的速度、更好的稳定性、更大的存储能力的存储解决方案
4. RAID 技术能够提供更大的存储空间、提供更快的传输速度并且提供更高的安全性
## RAID-0
1. RAID-0 是无冗余、无校验的磁盘阵列，实现 RAID-0 至少需要两块以上硬盘。它将两块以上的硬盘合并成一块，数据同时分散在每块硬盘中，因为带宽加倍，所以读/写速度加倍。RAID-0 的理论速度是单块硬盘的 N 倍
2. RAID-0 只是单纯地提高读/写性能，并没有为数据的可靠性提供保证，而且其中的任何一个物理盘失效都将影响到所有数据，因此，RAID-0 不能应用于数据安全性要求高的场合
![[Pasted image 20240620101600.png]]
## RAID-1
1. RAID-1 通过磁盘数据镜像实现数据的冗余，在两块磁盘上产生互为备份的数据，当其中一块成员盘出现故障时，系统还可以从另外一块成员盘中读取数据，因此 RAID-1 可以提供更好的冗余性
![[Pasted image 20240620101805.png]]
## RAID-3
RAID-3 的数据存取方式和 RAID-2 一样，把数据以位或字节为单位来分割并且存储到各个硬盘上，在安全方面以奇偶校验取代海明码做错误校正及检测，所以只需要一个额外的校检磁盘。奇偶校验值的计算是以各个硬盘的相对应位作异或的逻辑运算，然后将结果写入奇偶校验硬盘
![[Pasted image 20240620102200.png]]
## RAID-5
RAID-5 跟 RAID-4 一样，数据以条带为单位分布到各个硬盘上，RAID-5 和 RAID-4 的最大区别在于 RAID-5 不是把所有的校验块集中保存在一个专门的校验盘中，而是分散到所有的数据盘中
![[Pasted image 20240620102402.png]]
# 引导记录底层分析
## MBR
### 引导过程
1. BIOS 自检通过后将 MBR 扇区读入内存，将执行权交给内存中 MBR 扇区的引导程序，引导程序将自己拷贝到相对安全的地址
2. 系统判断 MBR 扇区的最后两个字节是否为"55 AA"，若是引导程序到分区表中查找是否有活动分区，若有责将引导扇区读入内存，若该引导扇区合法，则将程序执行流跳转到引导扇区从而引导操作系统启动
### 结构
1. 引导程序 (0-1B7H)：占用其中前 440 个字节
2. Windows 磁盘签名(1B8H-1BBH)：Windows 系统对硬盘初始化时写入的一个磁盘标签，如果硬盘的签名丢失，系统会认为该硬盘没有初始化
3. 分区表(Disk Partition Table)(1BEH-1FDH)：用于管理硬盘分区，占用 64 个字节
4. 结束标志(1FEH-1FFH)："55 AA"，如果破坏标志，硬盘会变成未初始化状态
### 分区表
1. MBR 磁盘的分区形式有主分区、扩展分区和非 DOS 分区
2. 非 DOS 分区用于将硬盘中的一块区域单独划分出来供另一个操作系统使用
3. 在分区表的 64 字节中，以 16 个字节为一个分区表项来描述一个分区的结构
4. 一块硬盘最多可以有 4 个主磁盘分区，被激活的主磁盘分区称为主分区，主分区在一块硬盘中只能有一个
#### 分区表项
| 字节偏移   | 字段长度 | 名称          | 含义                                     |
| ------ | ---- | ----------- | -------------------------------------- |
| 0x01BE | 1    | 引导标志        | 指明该分区是否是活动分区，80H可引导的活动分区，00H不可引导的非活动分区 |
| 0x01BF | 1    | 开始磁头        |                                        |
| 0x01C0 | 6b   | 起始扇区        | 该字节的后两位开始被柱面字段使用                       |
| 0x01C1 | 10b  | 起始柱面        | 系统分区时各分区均以柱面位单位，不允许跨柱面                 |
| 0x01C2 | 1    | 分区类型描述      | 定义了分区类型                                |
| 0x01C3 | 1    | 结束磁头        |                                        |
| 0x01C4 | 6b   | 结束扇区        |                                        |
| 0x01C5 | 10b  | 结束柱面        |                                        |
| 0x01C6 | 4    | 本分区之前使用的扇区数 | 从该磁盘开始到该分区开始之间的偏移量，以扇区数表示              |
| 0x01CA | 4    | 分区的总扇区数     | 分区包含的扇区总数                              |
![[Pasted image 20240620155644.png]]
#### 扩展分区
1. 拓展分区是一个指向下一个用来定义分区参数的指针
2. 扩展分区的每个逻辑驱动器的分区信息存储在一个类似于 MBR 的拓展引导记录中 (Extended Boot Record, EBR) 中，拓展引导记录包括分区表和结束标志"55 AA"，没有引导代码部分
3. 扩展分区的第一个分区项描述第一个逻辑驱动器，第二项指向下一个逻辑驱动器的 EBR
4. 拓展分区中的第一个分区表项中隐藏扇区数指的是相对于 EBR 的偏移
![[Pasted image 20240620160517.png|200]]![[Pasted image 20240620160542.png|500]]
## GPT
1. GPT(GUID Partition Table)：全局唯一表示磁盘分区表
2. GUID(Globally Unique Identifier)：全局唯一标识符
3. GPT 和 MBR 结构可以在支持 GPT 的系统上混合使用，但支持 EFI 的系统要求启动分区必须位于 GPT 磁盘上
4. 在系统支持的情况上可以将 MBR 磁盘转换为 GPT 磁盘，但只有在磁盘为空的情况下从能将 GPT 磁盘转换为 MBR 磁盘
5. GPT 磁盘上可以创建 6 种分区，分别是 EFI 系统分区 (ESP)、微软保留分区 (MSR)、LDM 元数据分区、LDM 数据分区、OEM 分区、主分区
	1. ESP：包含启动操作系统所需的文件，如驱动程序
	2. MSR：在 GPT 磁盘上保留空间以供以后的操作系统软件使用
	3. LDM：将基本 GPT 磁盘转换为动态 GPT 磁盘时，系统会创建 LDM 元数据分区和 LDM 数据分区，LDM 元数据分区为 1 MB，用于存储 LDM 数据库，LDM 数据分区包含了转换后磁盘上未分配的磁盘空间和动态卷
	4. OEM：系统制造商创建的分区
	5. 主分区：GPT 磁盘的基本数据分区，用于存放用户的数据
### EFI
1. EFI(Extensible Firmware Interface)：可拓展固件接口
2. Intel 在 64 位的安腾 (Itanium) 处理器上推出了 EFI 技术
3. EFI 在开机时检查硬件的完好性，同时加载硬件在 EFI 中的驱动程序，不用操作系统负责驱动的加载工作
4. 如果主板使用 BIOS，操作系统必须面对所有的硬件，每次重装系统或者系统升级时，都必须手动安装新的驱动
5. EFI 架构使用的驱动基于 EFIByte Code，需要 EFI 层进行翻译，EFI 将硬件层保护了起来，操作系统看到的只是 EFI 留给 EFIByte Code 的程序接口，一份驱动程序可以支持所有操作系统平台
6. EFI 以小型磁盘分区的形式存放在硬盘上，包括以下几个部分
	1. Pre-EFI 初始化模块
	2. EFI 驱动执行环境
	3. EFI 驱动程序
	4. 兼容性支持模块 (CSM)
	5. EFI 高层应用
	6. GUID 磁盘分区
7. EFI 初始化模块和驱动执行环境通常被集成在一个只读存储器中，Pre-EFI 初始化程序在系统开机时最先得到执行，负责最初的 CPU、北桥、南桥、内存和硬盘的初始化工作，随后 EFI 驱动程序被载入运行
8. 在 EFI 中引入了 GUID 磁盘分区系统，分区类型由 GUID 来表示。
9. EFI 系统分区可以被 EFI 系统存取，用于存放部分驱动和应用程序
10. CSM 为不具备 EFI 引导能力的操作系统提供类似于传统 BIOS 的系统服务
### 分区结构
![[Pasted image 20240620170353.png]]
1. 保护 MBR ：位于 0 号扇区，没有引导程序，分区表中只有一个表象，描述一个类型为 0xEE 的分区，分区起始地址是 1 号扇区，大小为"FF FF FF FF"，让计算机认为这个磁盘是合法额度，并且已经被使用
2. GPT 头：定义分区表的起始位置、分区表的结束位置、每个分区表表项的大小、分区表项的个数及分区表的校验和等信息
3. 分区表：GPT 磁盘的 2-33 号扇区，能容纳 128 个分区表项，每个分区表项大小为 128 字节，分区表项记录分区的起始和结束地址、分区类型的 GUID、分区名字、分区属性和分区 GUID 
4. 分区区域：通常起始于磁盘的 34 号扇区，包含多个具体分区
5. GPT 头备份：GPT 头所在扇区号和 GPT 头备份所在扇区号交换并且字节总数和 CRC 校验和均为头备份
6. 分区表备份：对分区表 32 个扇区的完整备份
#### GPT 头
| 字节偏移 | 字段长度 | 名称            | 含义                         |
| ---- | ---- | ------------- | -------------------------- |
| 0x00 | 8    | 签名            | 固定为 ASCII 码"EFI PART"      |
| 0x08 | 4    | 版本号           |                            |
| 0x0C | 4    | GPT 头字节总数     | 不包含后面的保留段长度                |
| 0x10 | 4    | GPT 头 CRC 校验和 |                            |
| 0x14 | 4    | 保留            |                            |
| 0x18 | 8    | GPT 头所在扇区号    |                            |
| 0x20 | 8    | GPT 头备份所在扇区号  |                            |
| 0x28 | 8    | GPT 分区区域起始扇区号 |                            |
| 0x30 | 8    | GPT 分区区域结束扇区号 |                            |
| 0x38 | 16   | 磁盘 GUID       |                            |
| 0x48 | 8    | GPT 分区表起始扇区号  |                            |
| 0x50 | 4    | 分区表项数         | Windows 系统限制 GPT 分区个数为 128 |
| 0x54 | 4    | 每个分区表项的字节数    | 固定 128 B                   |
| 0x58 | 4    | 分区表 CRC 校验和   |                            |
| 0x5C | 420  | 保留            |                            |
#### 分区表项

| 字节偏移 | 字段长度 | 名称           | 含义                                                                                                                                                                                                                                                   |
| ---- | ---- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0x00 | 16   | 分区类型GUID     | Microsoft定义<br>MSR “16 E3 C9 E3 5C 0B B8 4D 81 7D F9 2D F0 02 15 AE”<br>LDM Meta “AA C8 08 58 8F 7E E0 42 85 D2 E1 E9 04 34 CF B3”<br>LDM “A0 60 9B AF 31 14 62 4F BC 68 33 11 71 4A 69 AD”<br>主分区 “A2 A0 D0 EB E5 B9 33 44 87 C0 68 B6 B7 26 99 C7” |
| 0x10 | 16   | 分区GUID       | 每个分区唯一                                                                                                                                                                                                                                               |
| 0x20 | 8    | 分区起始地址       | LBA                                                                                                                                                                                                                                                  |
| 0x28 | 8    | 分区结束地址       | LBA                                                                                                                                                                                                                                                  |
| 0x30 | 8    | 分区属性         |                                                                                                                                                                                                                                                      |
| 0x38 | 72   | 分区名(Unicode) |                                                                                                                                                                                                                                                      |

# 文件系统底层分析
## FAT32
1. FAT 32 文件系统是从微软 Windows 95 系统的 OSR 2 版本开始使用的，它能够支持大于 32 MB 小于 32 GB 的分区。虽然第三方的格式化程序可以把超过 32 GB 的分区格式化为 FAT 32，但微软自身的系统不允许将大于 32 GB 的分区格式化为 FAT 32 文件系统
2. FAT 32 文件系统由 DBR 及其保留扇区、FAT 1、FAT 2、DATA 区四个部分组成
![[Pasted image 20240620103156.png]]
1. DBR 及其保留扇区：DBR 的全称为 DOSBoot Record，含义是 DOS 引导记录，也称为操作系统引导记录，在 DBR 之后往往有一些保留扇区
2. FAT1：FAT 的全称是 File Allocation Table，含义是文件分配表，FAT32 一般有两份 FAT，FAT1 是第一份，也是主 FAT。
3. FAT2：FAT2 是 FAT32 的第二份文件分配表，也是 FAT1 的备份。
4. DATA：数据区，是 FAT32 文件系统的主要区域，其中包含目录区域。

### DBR
1. 跳转指令：本身占 2 字节，它将程序执行流程跳转到引导程序处
2. OEM 代号：这部分占 8 字节，其内容由创建该文件系统的 OEM 产商提供
3. BPB：从第 12 个字节开始，占用 79 字节，记录了有关该文件系统的重要信息，前 53 个字节是 BPB，后面 26 个字节是扩展 BPB。各参数解释如下表：

| 字节偏移 | 字段长度 | 名称        | 定义                                                                   |
| ---- | ---- | --------- | -------------------------------------------------------------------- |
| 0x0B | 2    | 扇区字节数     | 硬件扇区的大小，合法的十进制值有 512，1024，2048，4096                                  |
| 0x0D | 1    | 每簇扇区数     | 一簇中的扇区数                                                              |
| 0x0e | 2    | 保留扇区数     | 第一个 FAT 开始之前的扇区数                                                     |
| 0x10 | 1    | FAT 数     | 该分区上 FAT 的副本数，本字段一般为 2                                               |
| 0x11 | 2    | 根目录项数     | FAT32 本字段必须设置为 0                                                     |
| 0x13 | 2    | 小扇区数      | FAT32 本字段必须设置为 0                                                     |
| 0x15 | 1    | 媒体描述符     | 提供有关媒体被使用的信息                                                         |
| 0x16 | 2    | 每 FAT 扇区数 | FAT32 本字段必须设置为 0                                                     |
| 0x18 | 2    | 每道扇区数     | -                                                                    |
| 0x1A | 2    | 磁头数       | -                                                                    |
| 0x1C | 4    | 隐藏扇区数     | 该分区上引导扇区之前的扇区数，在没有分区的媒体上它必须总是 0                                      |
| 0x20 | 4    | 总扇区数      | 本字段包含 FAT32 分区中总的扇区数                                                 |
| 0x24 | 4    | 每 FAT 扇区数 | 该分区每个 FAT 所占的扇区数，利用这个数和 FAT 数以及隐藏扇区数来决定根目录从哪开始。从目录的项数决定该分区的用户数据区从哪开始 |
| 0x28 | 2    | 扩展标志      | -                                                                    |
| 0x2A | 2    | 文件系统版本    | -                                                                    |
| 0x2C | 4    | 根目录簇号     | 根目录第一簇的簇号，一般为 2                                                      |
| 0x30 | 2    | 文件系统信息扇区号 | FAT32 分区的保留区中文件系统信息结构的扇区号                                            |
| 0x34 | 2    | 备份引导扇区    | 表示该分区保存引导扇区的副本的保留区中的扇区号，一般为 6，建议不使用其他值                               |
| 0x36 | 12   | 保留字段      | -                                                                    |
| 0x40 | 1    | 物理驱动器号    | -                                                                    |
| 0x41 | 1    | 保留        | FAT32 该字段总是 0                                                        |
| 0x42 | 1    | 扩展引导标签    | -                                                                    |
| 0x43 | 4    | 分区序号      | -                                                                    |
| 0x47 | 11   | 卷标        | -                                                                    |
| 0x52 | 8    | 系统 ID     | FAT32 中一般为"FAT32"                                                    |

### FAT 表

1. FAT32 文件一般有两份 FAT，它们由格式化程序在对分区进行格式化时创建，FAT1 是主，FAT2 是备份
2. FAT1 跟在 DBR 之后，其具体地址由 DBR 的 BPB 参数中指定，FAT2 跟在 FAT1 后面
3. FAT 表由 FAT 表项组成，每个 FAT 项占用 4 字节
4. 每个 FAT 项有个固定的编号，从 0 开始
5. FAT 表的前两个项为文件系统保留使用，0 号为介质类型，1 号为文件系统错误标志
6. 分区的数据区中每个簇都会映射到 FAT 表中的唯一一个 FAT 项，用户的数据从 2 号 FAT 开始记录
7. 如果某个文件占用很多个簇，则第一个 FAT 项记录下一个 FAT 项的编号，如果这个文件结束了，则用 `0F FF FF FF` 表示
8. 分区格式化后，用户文件以簇为单位存放在数据区中，一个文件至少占用一个簇
9. FAT 的主要作用是标明分区存储的介质以及簇的使用情况

定位 FAT 绝对位置的方法如下：
+ 首先从 MBR 的分区表中得知分区的起始扇区，偏移到此扇区
+ 从 DBR 的 BPB 中得知 DBR 的保留扇区数，FAT 表的个数，FAT 表的大小
+ 因此 FAT1 扇区号 = 分区起始扇区 + DBR 保留扇区，FAT2 扇区号 = 分区起始扇区 + DBR 保留扇区 + 每 FAT 扇区数

除了 0 号 FAT 项和 1 号 FAT 项以外，如果一个 FAT 项为非零值，那么可能有三种情况： 
 1. 该 FAT 项映射的簇是一个不可用的坏簇，那么该 FAT 项中的值为坏簇标志（对于 FAT 32 来说为“0F FF FF F7”）
 2. 该 FAT 项映射的簇是某个文件的最后一个簇，那么该 FAT 项中的值为结束标志（对于 FAT 32 来说为“0F FF FF FF”）
 3. 该 FAT 项映射的簇被某个文件占用，但并不是文件的最后一个簇，那么该 FAT 项中的值是文件下一个簇的簇号。 

分析 FAT32 文件系统的数据区
+ 定位方法：
	- 通过 MBR 中分区表信息得知分区的起始位置
	- 通过分区中 DBR 得知 DBR 的保留扇区数以及 FAT 表的大小，FAT 表的个数
	- 数据区 = 分区起始扇区 + DBR 保留扇区 + FAT 表数量 * 每 FAT 扇区数
+ 数据区的内容主要由三部分组成：根目录，子目录和文件内容
+ 数据区中以“簇”为单位进行存储，2 号簇被分配给根目录使用
+ FAT32 文件系统中，分区根目录下的文件和目录都放在根目录区中，子目录中的文件和目录都放在子目录区中，并且每 32 个字节为一个目录项（FDT），每个目录项记录着一个目录和文件或多个目录项记录一个文件和目录
+ FAT32 文件系统中，目录项可以分为四类：
	- 卷标目录项
	- ./..
	- 短文件名目录项
	- 长文件名目录项
+ FDT 第一个字节表明了该文件的状态，有下面四种取值方式：
	- 00h 目录项的空目录
	- E5H 表示该目录项曾经使用过，但文件已经被删除
	- 2EH 表示子目录下的两个特殊文件 . 或 ..
	- 其他任何字符 表示一个文件名或目录名的第一个字符的ASCII码值
+ FDT 第 0xB 个字节可以判别式长文件目录项还是短文件目录项
+ FAT32 文件目录项第 32 个字节表示一些文件的属性信息，包括文件名，扩展名，权限等

### 短文件名目录项
| 字节偏移 | 字段长度 | 字段内容及含义                                                                                              |
| ---- | ---- | ---------------------------------------------------------------------------------------------------- |
| 0x00 | 8    | 主文件名                                                                                                 |
| 0x08 | 3    | 文件扩展名                                                                                                |
| 0x0B | 1    | 文件属性：00000000(读写) 00000001(只读) 00000010(隐藏) <br>00000100(系统) 00001000(卷标) 00010000(子目录) 00100000(存档) |
| 0x0C | 1    | 未用                                                                                                   |
| 0x0D | 1    | 文件创建时间，精确到 10 ms 的值                                                                                  |
| 0x0E | 2    | 文件创建时间，包括时、分、秒                                                                                       |
| 0x10 | 2    | 文件创建日期，包括年、月、日                                                                                       |
| 0x12 | 2    | 文件最近访问日期，包括年、月、日                                                                                     |
| 0x14 | 2    | **文件起始簇号的高位**                                                                                        |
| 0x16 | 2    | 文件修改时间，包括时、分、秒                                                                                       |
| 0x18 | 2    | 文件修改日期，包括年、月、日                                                                                       |
| 0x1A | 2    | **文件起始簇号的低位**                                                                                        |
| 0x1C | 2    | 文件大小                                                                                                 |
### 长文件名目录项
| 字节偏移 | 字段长度 | 字段内容及含义                                                 |
| ---- | ---- | ------------------------------------------------------- |
| 0x00 | 1    | 序列号，从 1 开始                                              |
| 0x01 | 10   | 文件名的第 1 - 5 个 Unicode 码字符，若文件已经记录完填充“00”，随后未用的字节用“FF”填充 |
| 0x0B | 1    | 长文件名目录项的属性标志，固定为”0F“                                    |
| 0x0C | 1    | 保留未用                                                    |
| 0x0D | 1    | 短文件名校验和                                                 |
| 0x0E | 12   | 文件名的第 6 - 11 个 Unicode 码字符                              |
| 0x1A | 2    | 始终为 0                                                   |
| 0x1C | 2    | 文件名的第 12 - 13 个 Unicode 码字符                             |
### "."目录项和".."目录项
1. 两者的文件属性为子目录"00010000"
2. "."目录项所描述的"起始簇号"是子目录本身所在的簇号
3. ".."目录项所描述的"起始簇号"是上一级目录的起始簇号，如果上一级目录是根目录，则该值被置为"0"
4. 两者文件大小都为"0"
### 卷标目录项
1. 在根目录区表示分区的名字
2. ![[Pasted image 20240620145732.png]]
3. FAT 格式的分区，卷标长度最多允许达到 11 字节，支持最多 5 个中文字符
4. 不记录起始簇号和大小
5. 不记录创建时间和最后访问时间，只记录修改时间
### 删除文件
1. 文件目录项的第一个字节被改成"E5"
2. 目录项中文件起始簇号的高位 2 个字节清零，若文件在数据区存放的位置比较靠后，文件起始簇号会很大，文件记录项中高位 2 个字节会有值，会造成文件起始簇号丢失
	1. 若将文件先放入回收站，再清空回收站，不会清除起始簇号高位的两个字节
	2. 彻底删除时会
3. 文件 FAT 表的相应簇链全部清零
4. 文件的内容不会被清零，但占用的簇号会被释放，容易被其他文件进一步占用，若数据被覆盖了则文件无法恢复
5. 彻底删除文件夹时，被删除文件夹目录项中起始簇号的高位两字节会被清空，文件夹中文件的目录项不会发生变化
### 格式化
1. FAT 表中除了 0 号 FAT 项、1 号 FAT 项和 2 号 FAT 项以外会被清空
2. 根目录区会被完全清零
3. 子目录中的目录项仍然存在

## NTFS
1. NTFS 文件系统具有安全性、可恢复性、文件压缩、磁盘配额和基于 B+树的文件管理等特点
2. NTFS 分区又被称为 NTFS 卷，卷上簇的大小又称为卷因子
3. 当一个分区由 FAT 卷转变成一个 NTFS 卷时，卷因子的大小总是占用一个扇区
4. NTFS 使用逻辑簇号 (Logical Cluster Number, LCN) 和虚拟簇号 (Virtual Cluster Number, VCN) 对卷进行管理
	1. LCN： 对卷的第一个簇到最后一个簇编号
	2. VCN：将特定文件的簇从头到尾编号
### 分区结构
1. DBR扇区
2. NTLDR 扇区
3. 元数据文件 (DBR 扇区和 NTLDR 扇区共同组成 $Boot 源文件)
![[Pasted image 20240620205121.png]]

![[Pasted image 20240620224311.png]]
#### $Boot
1. 跳转指令：跳转指令的目标地址以指令的下一字节为基准，占 2 字节
2. 空指令：90H，占 1 字节
3. OEM 代号：占 8 字节
4. BIOS 参数块 (BIOS Parameter Block, BPB) (0BH-53H)
5. 引导程序 (54H-1FDH)：占 426 个字节，负责将系统文件 NTLDR 装入，对于未安装操作系统的分区这段程序没有用处
6. 结束标志："55 AA"

##### BPB
![[Pasted image 20240620211855.png]]

#### $MFT
1. 主文件表由
## EXT4

# 数据文件分析

# 操作系统数据分析
## Windows
#### 回收站
1. Windows 中的回收站本质上是一个应用程序，其应用程序操作的内容保存在硬盘根目录下的 `$Recycle.bin` 文件夹中
2. 具体的回收站文件夹分析可以参考 [$Recycle.Bin Forensics for Windows 7 and Windows Vista](https://redirect.cs.umbc.edu/courses/undergraduate/FYS102D/Recycle.Bin.Forensics.for.Windows7.and.Windows.Vista.pdf)
3. `$Recycle.bin` 文件夹下有若干个 S 开头的子文件夹，子文件夹的名字是基于用户的 SID(Security Identifier) 生成的，SID 用于对于用户或者组来说是唯一确定的，在用户第一次登陆后才会存在，结合每个驱动器上的逻辑分区都有一个 `$Recycle.bin` 文件夹，相当于每个用户在每个逻辑分区上都有一个私人回收站
	1. `1` 指版本级别（始终为 1）。
	2. `5` 标识权限级别，Microsoft称之为"IdentifierAuthority"。在图中 `5` 指的是NT权限。
	3. 字符串的其余部分，来自 `21-1428609294-...`是域或本地计算机标识符（或一个或多个子授权值）。这是一个变量编号，用于标识创建该号码的计算机（或网络）
	4. 末尾的 `500` 称为“相对 ID”，在本例中，`500` 表示用户是系统管理员
	5. 在注册表 `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList` 目录下可以找到 SID 和用户文件夹的对应信息![[Pasted image 20240621165349.png]]
4. 每个删除对象都有一个 \$R \<FileID> 文件和  \$I  \<FileID>前缀文件，\$R 对应删除文件的内容，`R` 可能代表回收或恢复的意思，\$I 对应删除文件的元数据，\<FileID> 是一个六个字符的字母数字字符串，很可能用于唯一标识此文件 ![[Pasted image 20240621092330.png]]
5. 对于 FAT 文件系统，删除文件的元数据包括标识符、文件大小、时间戳、文件路径长度和文件路径。对于 NTFS 文件系统，删除文件的元数据即为文件的 $MFT 文件记录。关于 $I 和 $R 文件的具体结构，但是在 Windows 11 Arm 环境测试时，发现 NTFS 分区中生成的元数据并并非 \$MFT 文件记录，而是标识符、文件大小、时间戳、文件路径长度和文件路径
	1. ![[Pasted image 20240621161735.png]]
	2. 将文件 Restore 后元数据文件并未发生变化 ![[Pasted image 20240621161705.png]]
	3. 偏移 0x8 开始的 8 个字节代表了删除文件的大小 53B (0x35)
	4. 偏移 0x10 开始的 8 个字节是文件被删除的时间 (距离 1601:01:01 08:00:00的 100 纳秒数，系统的时区为 UTC+8 )，在转换时先将小端序表示的时间按字节翻转，然后转换为十进制后乘上 100 在除以 1,000,000,000 加上初始值即得到时间 ![[Pasted image 20240621164058.png]]
	5. 偏移 0x18 开始的 4 个字节记录了文件路径长度，图中为 19 个 Unicode 字符
6. 当文件从回收站清除后，回收站文件夹中的 \$I 和 \$S 文件消失了![[Pasted image 20240621172739.png]]
### 注册表
1. 注册表文件是 Windows 操作系统中的一个关键组件，用于存储系统和应用程序的配置信息
2. 对注册表的修改具有原子性
3. 读取注册表文件可以通过访问注册表文件，也可以通过调用注册表查看编辑器的方式
#### Root Keys
1. 注册表数据库根级别下的键通常以其的 Windows API 定义命名，经常被缩写为以"HK"开头的三个字母或四个字母的短名称，他们是保存在内存中或者存储在配置文件中特定键的预定义的句柄，在启动时由 Kernel 加载并且在操作系统运行的所有进程中共享
##### HKEY_LOCAL_MACHINE (HKLM)
1. 用于存储本机的特定信息
2. 由 HKLM 索引的键在操作系统启动时被内核从 %SystemRoot%\\System32\\config 加载到内存中，应用程序无法创建该根键任何子项
##### HKEY_CLASSES_ROOT (HKCR)
1. 包含已注册的应用程序信息，比如默认应用程序等
##### HKEY_USERS (HKU)
##### HKEY_CURRENT_USER (HKCU)
1. 用于存储当前用户的设置，HKCU 存储了指向与当前用户相对应的 HKU 的子键的链接，相当于引用了 (HKU)\\(SID)\\...

### 日志文件
1. Windows 系统日志记录了系统中硬件、软件和系统问题的信息，并监视系统中发生的事件，日志文件存储在 `C:\Windows\System32\winevt\Logs` 下
2. Evtx 文件是微软从 Windows NT 6.0 之后开始采用的一种全新的日志文件格式，在此之前的格式是 evt。Evtx 由 Windows 事件查看器创建，包含 Windows 记录的事件列表，以专有的二进制 XML 格式保存
#### Evtx 文件结构
1. 可以参考 [Windows XML Event Log]( https://github.com/libyal/libevtx/blob/main/documentation/Windows%20XML%20Event%20Log%20 (EVTX). Asciidoc)
### 缩略图
1. 缩略图文件的存储位置为 `C:\Users\<USERNAME>\AppData \Local\Microsoft\Windows\Explorer`
2. 缩略图文件取证的作用包括
	1. 即便文件删除，缩略图会一直保留在 thumb.db 中。
	2. 文件系统使用 EFS 加密，也可能以非 加密形式显示 thumb.db 中的缩略图 图像。
	3. 图片文件已经从硬盘拷贝到移动 存储设备中，原始硬盘中也会留下 thumb.db 文件。
3. Thumbcache Viewer 可以用于解析 thumbcache_\*.db  数据库
### 最近访问文件
1. 最近访问文件的存储位置为`C:\Users\<USERNAME>\AppData \Roaming\Microsoft\Windows\Recent`
2. 以快捷方式文件 (.lnk) 的形式存储
3. 快捷方式文件包含与目标文件相关的有价值的信息，如时间戳、文件大小、卷详细信息和原始文件路径等
## Android

### 系统分区
1. BootLoader：设备启动后，首先进入 BootLoader 程序进行硬件检测和初始化，选择启动模式，如 Android 系统、recovery 模式、fastboot 模式等。
2. Boot 分区：存放启动和引导文件，启动 Android 系统时会引导 kernel 并加载 ramdisk。
3. System 分区：包含操作系统和系统软件。Vendor 定制的预装应用和库文件也放在该分区。
4. Data 分区：存放用户数据，包括联系人、短信、设置、用户安装的程序。擦除此分区相当于恢复出厂设置。
5. Cache 分区:存放应用的缓存数据、 缓存系统升级包等。
6. Recovery 分区:包含一个简易 Linux 系统，用于恢复和维护手机。
7. Misc 分区:包含系统设置和功能启用禁用的相关设置。
8. Sdcard 分区:内部存储，可存放照片、视频、文档、ROM 安装包等
### 目录
- /system/bin 目录: 存放几乎所有共享库的.so 文件。
- /system/app 目录: 存放系统自带的应用。
- /system/framework 目录: 存放启用 Android 系统的框架文件。
- /system/lib 目录: 存放应用程序用到的库文件。
- /data/system 目录: 记录手机中安装的软件、小部件等信息。
- /data/app 目录: 用户自己安装的应用程序。
- /data/misc 目录: 保存 WiFi 账号和 VPN 等配置信息。
- /data/data 目录: 应用的用户文件存储位置，是分析应用数据的关键位置。

### 取证
1. 数据来源: 包括机身存储、手机卡、外置存储、备份数据、云数据、移动运营商提供的数据等
2. 身份信息: 包括 IMSI、IMEI、ESN、MEID、ICCID 等
#### 取证方法
1. 人工提取: 直接在移动终端上查看相关数据，使用相机翻拍记录证据。
2. 代理取证: 通过取证工具向安卓手机推送取证程序，读取应用数据并返回给取证电脑。
3. 备份取证: 制作手机数据的副本数据，进行数据恢复。
4. 逻辑取证: 获取手机中文件系统级别的数据，如文件拷贝。
5. 物理取证: 获取手机机身存储芯片的所有数据，是最完整的数据获取方法。
6. 云取证: 对存储在云端的数据进行取证，通过提取手机 APP 本地密钥进行逆向解密。

# 应用程序数据分析

1. 分析可执行文件检测应用程序的功能、运行流程等，可采用静态分析或动态分析方法
2. 分析安装文件回溯程序来源
3. 分析临时文件了解程序运行过程或者用户操作痕迹
4. 配合分析用户数据文件
## Android
### APK 文件
![[Pasted image 20240621191609.png]]
- AndroidManifest.xml
    - 该文件主要用于声明应用程序的名称，组件，权限等基本信息。
- class.dex
    - 该文件是 dalvik 虚拟机对应的可执行文件，包含应用程序的可执行代码。
- resource.arsc
    - 该文件主要是应用程序编译后的二进制资源以及资源位置与资源 id 之间的映射关系，如字符串。
- assets
    - 该文件夹一般用于包含应用程序的原始资源文件，例如字体和音乐文件。程序在运行的时候，可以通过 API 获取这些信息。
- lib/
    - lib 目录下主要用于存储通过 JNI（Java Native Interface）机制使用的本地库文件，并且会按照其支持的架构，分别创建对应的子目录。
- res/
    - 该目录主要包含了 Android 应用引用的资源，并且会按照资源类型进行存储，如图片，动画，菜单等。主要还有一个 value 文件夹，包含了各类属性资源
- colors.xml→颜色资源
- dimens.xml---> 尺寸资源
- strings---> 字符串资源
- styles.xml→样式资源
- META-INF/
    - 类似于 JAR 文件，APK 文件中也包含了 META-INF 目录，用于存放代码签名等文件，以便于用来确保 APK 文件不会被人随意修改。

### 浏览器

### 短信与彩信

### 联系人

## Windows

### PE 文件

#### 32 位 PE 文件布局
```
+-------------------------------+ \
|     MS-DOS MZ header          |  |
+-------------------------------+  |
| MS-DOS Real-Mode Stub program |  |
+-------------------------------+  |
|     PE Signature              |  | -> PE file header
+-------------------------------+  |
|     IMAGE_FILE_HEADER         |  |
+-------------------------------+  |
|     IMAGE_OPTIONAL_HEADER     |  |
+-------------------------------+ /
|     section header #1         | 
+-------------------------------+ 
|     section header #2 
+------------------------- 
: 
: 
 
+------------------------------+ 
|        section #1            | 
+------------------------------+ 
|        section #2 
+-------------------- 
: 
: 
```
#### MS-DOS 文件头
![[Pasted image 20240410084551.png]]
##### IMAGE_DOS_HEADER
```c
typedef struct _IMAGE_DOS_HEADER
{
     WORD e_magic;              // "MZ"
     WORD e_cblp;
     WORD e_cp;
     WORD e_crlc;
     WORD e_cparhdr;
     WORD e_minalloc;
     WORD e_maxalloc;
     WORD e_ss;
     WORD e_sp;
     WORD e_csum;
     WORD e_ip;
     WORD e_cs;
     WORD e_lfarlc;
     WORD e_ovno;
     WORD e_res[4];
     WORD e_oemid;
     WORD e_oeminfo;
     WORD e_res2[10];
     LONG e_lfanew;             // NT 头相对于文件起始处的偏移
} IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```
1. `e_magic`：DOS 签名 `4D 5A` ![[Pasted image 20240410084624.png]]
2. `e_lfanew`：`IMAGE_NT_HEADER`
 相对于文件起始处的偏移，图中 NT 头的相对于文件开头的偏移量为 0 x 80 ![[Pasted image 20240410084839.png]]

##### IMAGE_DOS_STUB
1. 当系统位于 MS-DOS 环境时输出 `This program cannot be run in DOS mode` 并退出程序 ![[Pasted image 20240410085107.png]]
##### IMAGE_NT_HEADERS
 ```c
 typedef struct _IMAGE_NT_HEADERS {
  DWORD                   Signature;         /* +0000h PE 标识 */
  IMAGE_FILE_HEADER       FileHeader;        /* +0004h PE 标准头 */
  IMAGE_OPTIONAL_HEADER32 OptionalHeader;    /* +0018h PE 可选头  */
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
 ```
 ![[Pasted image 20240410090239.png]]
###### PE Signature 
1. ` 50 45 00 00 ` 指明当前文件是 PE 格式的映像文件
###### IMAGE_FILE_HEADER
```c
typedef struct _IMAGE_FILE_HEADER {
  WORD  Machine;                    /* +0004h 目标机器类型 */
  WORD  NumberOfSections;           /* +0006h PE 中节的数量 */
  DWORD TimeDateStamp;              /* +0008h 时间戳 */
  DWORD PointerToSymbolTable;       /* +000ch 指向符号表的指针 */
  DWORD NumberOfSymbols;            /* +0010h 符号表中符号数目 */
  WORD  SizeOfOptionalHeader;       /* +0012h 可选头的大小 */
  WORD  Characteristics;            /* +0014h 文件属性标志 */
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
```
![[Pasted image 20240410090902.png]]
1. 又称 COFF 头 (标准通用文件格式头)
2. `Machine`：指明 CPU 类型 https://docs.microsoft.com/zh-cn/windows/win32/debug/pe-format?redirectedfrom=MSDN#machine-types
3. `NumberOfSections`：文件中存在的节区数量 ![[Pasted image 20240410091558.png]]
4. `TimeDateStamp`
：表示从 1970 年 1 月 1 日 00:00 到文件创建时经过的秒数，图中表示的时间戳经过了 `0x6604DA6F` 秒即 `1711594095` 秒，小端序高位在高处 ![[Pasted image 20240410091843.png]]
1. `PointerToSymbolTable`：符号表的文件偏移
2. `NumberOfSymbols`：符号表的符号数量
3. `SizeOfOptionalHeader` 可选头的大小 ![[Pasted image 20240410093305.png]]
4. `Characteristics`：标识文件属性，以 bit OR 方式组合
	1.  `0x0026` 二进制表示为 `0000 0000 0010 0110`
```c
// 文件属性标志
#define IMAGE_FILE_RELOCS_STRIPPED          0x0001    // 表示文件不包含重定位信息，只能在原定的基址加载。如果原定基址不可用，加载器会报出错误
#define IMAGE_FILE_EXECUTABLE_IMAGE         0x0002    // 表示文件可执行，如果该位未设置，意味着存在链接器错误
#define IMAGE_FILE_LINE_NUMS_STRIPPED       0x0004    // 不存在行信息
#define IMAGE_FILE_LOCAL_SYMS_STRIPPED      0x0008    // 不存在符号信息
#define IMAGE_FILE_AGGRESSIVE_WS_TRIM       0x0010    // 已废弃
#define IMAGE_FILE_LARGE_ADDRESS_AWARE      0x0020    // 应用可处理大于 2GB 的地址
#define IMAGE_FILE_BYTES_REVERSED_LO        0x0080    // 小尾存储。已废弃
#define IMAGE_FILE_32BIT_MACHINE            0x0100    // 基于 32-bit 体系结构
#define IMAGE_FILE_DEBUG_STRIPPED           0x0200    // 不存在调试信息
#define IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP  0x0400    // 如果映像文件在可移动介质上，完全加载并复制到内存交换文件中
#define IMAGE_FILE_NET_RUN_FROM_SWAP        0x0800    // 如果映像文件在网络介质上，完全加载并复制到内存交换文件中
#define IMAGE_FILE_SYSTEM                   0x1000    // 映像文件是系统文件
#define IMAGE_FILE_DLL                      0x2000    // 映像文件是动态链接库文件
#define IMAGE_FILE_UP_SYSTEM_ONLY           0x4000    // 文件只能在单处理器机器上运行
#define IMAGE_FILE_BYTES_REVERSED_HI        0x8000    // 大尾存储（已废弃）
```
![[Pasted image 20240410093828.png]]
###### IMAGE_OPTIONAL_HEADER
![[Pasted image 20240410101046.png]] ![[Pasted image 20240410101436.png]]
```
typedef struct _IMAGE_OPTIONAL_HEADER {
  WORD                 Magic;                            /* +0018h 魔数 */
  BYTE                 MajorLinkerVersion;               /* +001ah 链接器主要版本号 */
  BYTE                 MinorLinkerVersion;               /* +001bh 链接器次要版本号 */
  DWORD                SizeOfCode;                       /* +001ch 所有含代码的节的总大小 */
  DWORD                SizeOfInitializedData;            /* +0020h 所有含已初始化数据的节的总大小 */
  DWORD                SizeOfUninitializedData;          /* +0024h 所有含未初始化数据的节的总大小 */
  DWORD                AddressOfEntryPoint;              /* +0028h 程序入口点RVA */
  DWORD                BaseOfCode;                       /* +002ch 代码节起始RVA */
  DWORD                BaseOfData;                       /* +0030h 数据节起始RVA */
  DWORD                ImageBase;                        /* +0034h 映像文件加载时的首选地址 */
  DWORD                SectionAlignment;                 /* +0038h 内存中节对齐粒度*/
  DWORD                FileAlignment;                    /* +003ch 文件中节对齐粒度 */
  WORD                 MajorOperatingSystemVersion;      /* +0040h 操作系统主要版本号 */
  WORD                 MinorOperatingSystemVersion;      /* +0042h 操作系统次要版本号 */
  WORD                 MajorImageVersion;                /* +0044h 映像文件主要版本号 */
  WORD                 MinorImageVersion;                /* +0046h 映像文件次要版本号 */
  WORD                 MajorSubsystemVersion;            /* +0048h 子系统主要版本号 */
  WORD                 MinorSubsystemVersion;            /* +004ah 子系统次要版本号 */
  DWORD                Win32VersionValue;                /* +004ch 保留。置0 */
  DWORD                SizeOfImage;                      /* +0050h 内存中映像文件的大小 */
  DWORD                SizeOfHeaders;                    /* +0054h 所有头+节表大小 */
  DWORD                CheckSum;                         /* +0058h 映像文件校验和 */
  WORD                 Subsystem;                        /* +005ch 运行映像所需子系统 */
  WORD                 DllCharacteristics;               /* +005eh 映像文件的DLL属性 */
  DWORD                SizeOfStackReserve;               /* +0060h 初始化时的保留的栈大小 */
  DWORD                SizeOfStackCommit;                /* +0064h 初始化时实际提交的栈大小 */
  DWORD                SizeOfHeapReserve;                /* +0068h 初始化时保留的堆大小 */
  DWORD                SizeOfHeapCommit;                 /* +006ch 初始化时实际提交的堆大小 */
  DWORD                LoaderFlags;                      /* +0070h 已废弃 */
  DWORD                NumberOfRvaAndSizes;              /* +0074h 数据目录结构的数量 */
  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];     /* +0078h 指向数据目录中第一个 IMAGE_DATA_DIRECTORY 结构体的指针 */
} IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;
```
1. 提供了加载时必要的信息
2. `Magic`：指明映像文件的类型
	1. `0x0107` ROM 映像
	2. `0x010B` PE 32
	3. `0x020B` PE 32+
3. `MajorLinkerVersion`：链接器主要版本号
4. `MinorLinkerVersion`：链接器次要版本号
5. `SizeOfCode`：所有包含代码节的总大小 (文件对齐后)，判断某个节是否包含代码根据节属性是否包含 `IMAGE_SCN_CNT_CODE` ![[Pasted image 20240410102330.png]]
6. `SizeOfInitializedData`：所有包含已初始化数据节的总大小
7. `SizeOfUninitializedData`：所有包含未初始化数据节的总大小
8. `AddressOfEntryPoint`：入口点函数指针相对于映像文件加载基址的偏移量
9. `BaseOfCode`：代码节 RVA ，节名为 ". Text"
10. `ImageBase`：映像文件加载时的优先载入地址
### Chrome